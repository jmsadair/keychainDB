syntax = "proto3";

package chain;

option go_package = "github.com/jmsadair/keychain/proto/pbchain";

// ChainService is used by nodes within a chain to communicate with one another.
service ChainService {
	// Write handles requests to write a particular version of a key.
	rpc Write (WriteRequest) returns (WriteResponse) {}
	// Read handles requests to read a particular version of a key.
	rpc Read (ReadRequest) returns (ReadResponse) {}
	// Commit handles requests to commit a particular version of a key.
	rpc Commit(CommitRequest) returns (CommitResponse) {}
	// Propagate handles requests to list all key-value pairs that match the specified criterion.
	// This is useful when a new node is added to chain and needs to receive all of the key-value pairs it is missing.
	rpc Propagate (PropagateRequest) returns (stream KeyValuePair) {}
	// UpdateConfiguration handles requests to update the chain membership configuration.
	rpc UpdateConfiguration (UpdateConfigurationRequest) returns (UpdateConfigurationResponse) {}
	// Ping handles requests to check if the node is alive.
	rpc Ping (PingRequest) returns (PingResponse) {}
}

// ChainMember represents a member of the chain with an ID and address.
message ChainMember {
	// The unique ID of the chain member.
	string id = 1;
	// The address of the chain member.
	string address = 2;
}

// Configuration contains the membership configuration of the chain.
message Configuration {
	// The version of this configuration.
	uint64 version = 1;
	// The members of the chain with their IDs and addresses.
	repeated ChainMember members = 2;
}

// UpdateConfigurationRequest is a request for a node to update its chain membership configuration.
message UpdateConfigurationRequest {
	// The new configuration for the chain.
	Configuration configuration = 1;
}

message UpdateConfigurationResponse {}

// WriteRequest is a request sent from one node of a chain to another to write a new version of a key.
message WriteRequest {
	// The key being written.
	string key = 1;
	// The value for the key.
	bytes value = 2;
	// The version of the key.
	uint64 version = 3;
	// The configuration version.
	uint64 config_version = 4;
}

// WriteResponse is the response to a WriteRequest.
message WriteResponse {}

// ReadRequest is a request sent from one node of chain to another to read the value of a key.
message ReadRequest {
	// The key being read.
	string key = 1;
	// The configuration version.
	uint64 config_version = 4;
}

// ReadResponse is the response to a ReadRequest and contains the value of the key read.
message ReadResponse {
	// The value of the key that was read.
	bytes value = 1;
}

// PropagateRequest is used to initiate a server-to-client stream of key-value pairs.
message PropagateRequest {
	// Which type of key should be listed.
	KeyType key_type = 1;
	// The configuration version.
	uint64 config_version = 4;
}

// KeyType contains all key types that can be propagated.
enum KeyType {
	// All key-value pairs will be listed.
	KEYTYPE_ALL = 0;
	// Only committed key-value pairs will be listed.
	KEYTYPE_COMMITTED = 1;
	// Only dirty key-value pairs will be listed.
	KEYTYPE_DIRTY = 2;
}

// KeyValuePair is a key-value pair stored by a node of a chain.
message KeyValuePair {
	// The key.
	string key = 1;
	// The value associated with the key.
	bytes value = 2;
	// The version of the key.
	uint64 version = 3;
	// Whether or not this version of the key has been committed.
	bool is_committed = 4;
}

// CommitRequest is a request to commit a version of a key.
message CommitRequest {
	// The key being committed.
	string key = 1;
	// The version of the key being committed.
	uint64 version = 2;
	// The configuration version.
	uint64 config_version = 4;
}

// CommitResponse is a response to a CommitRequest.
message CommitResponse {}

// PingRequest is a request to check if the node is alive and has an up-to-date configuration.
message PingRequest {}

// PingResponse is a response to a PingRequest.
message PingResponse {
	uint64 config_version = 1;
	int32 status = 2;
}
