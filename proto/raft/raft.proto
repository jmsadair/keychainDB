syntax = "proto3";

package raft;

option go_package = "github.com/jmsadair/keychain/proto/raft";

import "google/protobuf/timestamp.proto";

service RaftService {
  // AppendEntries is used to append entries to the replicated log.
  rpc AppendEntries (AppendEntriesRequest) returns (AppendEntriesResponse) {}
  // AppendEntries is the same as AppendEntries but it streams the requests and responses.
  rpc AppendEntriesPipeline(stream AppendEntriesRequest) returns (stream AppendEntriesResponse) {}
  // RequestVote is used by a candidate to ask a peer for a vote in an election.
  rpc RequestVote (RequestVoteRequest) returns (RequestVoteResponse) {}
  // RequestPreVoteRequest is used by a candidate to ask a peer for a vote in an election.
  rpc RequestPreVote (RequestPreVoteRequest) returns (RequestPreVoteResponse) {}
  // InstallSnapshotRequest is invoked by a peer to bootstrap this node's log and state machine from a snapshot.
  rpc InstallSnapshot (stream InstallSnapshotRequest) returns (InstallSnapshotResponse) {}
  // TimeoutNow is used to start a leadership transfer to this node.
  rpc TimeoutNow (TimeoutNowRequest) returns (TimeoutNowResponse) {}
}

// AppendEntriesRequest is the command used to append entries to the replicated log.
message AppendEntriesRequest {
  RpcHeader rpc_header = 1;
  uint64 term = 2;
  bytes leader = 3;
  uint64 prev_log_entry = 4;
  uint64 prev_log_term = 5;
  uint64 leader_commit_index = 6;
  repeated Log entries = 7;
}

// AppendEntriesResponse is the response returned from an AppendEntriesRequest.
message AppendEntriesResponse {
  RpcHeader rpc_header = 1;
  uint64 term = 2;
  uint64 last_log = 3;
  bool success = 4;
  bool no_retry_backoff = 5;
}

// RequestPreVoteRequest is the command used by a candidate to ask a Raft peer for a vote in an election.
message RequestPreVoteRequest {
  RpcHeader rpc_header = 1;
  uint64 term = 2;
  uint64 last_log_index = 3;
  uint64 last_log_term = 4;
}

// RequestPreVoteResponse is the response returned from a RequestPreVoteRequest.
message RequestPreVoteResponse {
  RpcHeader rpc_header = 1;
  uint64 term = 2;
  bool granted = 3;
}

// RequestVoteRequest is the command used by a candidate to ask a Rpeer for a vote in an election.
message RequestVoteRequest {
  RpcHeader rpc_header = 1;
  uint64 term = 2;
  bytes candidate = 3;
  uint64 last_log_index = 4;
  uint64 last_log_term = 5;
  bool leadership_transfer = 6;
}

// RequestVoteResponse is the response returned from a RequestVoteRequest.
message RequestVoteResponse {
  RpcHeader rpc_header = 1;
  uint64 term = 2;
  bytes peers = 3;
  bool granted = 4;
}

// InstallSnapshotRequest is the command sent to a peer to bootstrap its log (and state machine) from a snapshot on another peer.
message InstallSnapshotRequest {
  RpcHeader rpc_header = 1;
  int32 snapshot_version = 2;
  uint64 term = 3;
  bytes leader = 4;
  uint64 last_log_index = 5;
  uint64 last_log_term = 6;
  bytes peers = 7;
  bytes configuration = 8;
  uint64 configuration_index = 9;
  int64 size = 10;
  bytes data = 11;
}

// InstallSnapshotResponse is the response returned from an InstallSnapshotRequest.
message InstallSnapshotResponse {
  RpcHeader rpc_header = 1;
  uint64 term = 2;
  bool success = 3;
}

// TimeoutNowRequest is the command used by a leader to signal another server to start an election.
message TimeoutNowRequest {
  RpcHeader rpc_header = 1;
}

// TimeoutNowResponse is the response to TimeoutNowRequest.
message TimeoutNowResponse {
  RpcHeader rpc_header = 1;
}

// Log represents an entry in the replicated log.
message Log {
  uint64 index = 1;
  uint64 term = 2;
  uint32 type = 3;
  bytes data = 4;
  bytes extensions = 5;
  google.protobuf.Timestamp appended_at = 6;
}

// RPCHeader is a common sub-structure used to pass along protocol version and other information about the cluster.
// For older Raft implementations before versioning was added this will default to a zero-valued structure when
// read by newer Raft versions.
message RpcHeader {
  int32 protocol_version = 1;
  bytes id = 2;
  bytes addr = 3;
}
